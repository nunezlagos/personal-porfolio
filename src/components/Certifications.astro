---
interface Certification {
  id: string;
  name: string;
  date?: string;
  description: string;
  img: string;
  repository?: string;
  skill: string[];
}
interface Props {
  certifications: Certification[];
}
const { certifications } = Astro.props;
const truncate = (s: string, max = 150) => (s.length > max ? s.slice(0, max) + '...' : s);
const capitalize = (s: string) => s.charAt(0).toUpperCase() + s.toLowerCase().slice(1);
const displayItems = certifications.slice(0, 3);
---

<section class="certifications section" id="certifications" role="region" aria-label="Certificaciones">
  <div class="container">
    <div class="row">
      <div class="col-lg-12 text-center">
        <h2 class="card-title" data-aos="fade-up" data-anim-id="section-title">CERTIFICACIONES</h2>
        <h6 class="card-subtitle" data-aos="fade-up" data-anim-id="section-subtitle">Últimas certificaciones obtenidas</h6>
      </div>
      <div class="row mt-3" id="certification" role="list" data-anim-container="card-item">
        {displayItems.map((item, index) => (
          <div class="col-lg-4 col-md-6 col-12 pb-5" data-aos="fade-up" data-anim-item="card-item">
            <div
              class="class-thumb"
              data-toggle="modal"
              data-target="#certificationModal"
              data-title={item.name}
              data-description={item.description}
              data-img={item.img}
              data-repository={item.repository ?? ''}
              role="button"
              tabindex={0}
            >
              <img src={item.img} class="img-fluid" alt={item.name} />
              <div class="class-info">
                <h3 class="card-name mb-1">{item.name}</h3>
                <p class="card-description mt-3 card-description-text">{truncate(item.description)}</p>
                <div class="tag-container">
                  <ul class="list-inline mt-3 tag-container">
                    {item.skill.slice(0, 3).map((s) => (
                      <li class="list-inline-item">
                        <span class="tag"><strong>{capitalize(s)}</strong></span>
                      </li>
                    ))}
                  </ul>
                </div>
              </div>
            </div>
          </div>
        ))}
      </div>
      <div class="col-lg-12 text-right mt-5" data-aos="fade-up" data-anim-id="more-btn">
        <a href="#" data-toggle="modal" data-target="#certificationList" class="custom-btn-text mt-3 flex-fill mx-2 smoothScroll" role="button" aria-label="Ver más certificaciones">
          Más certificaciones &nbsp;&nbsp;<i class="fa fa-chevron-right" aria-hidden="true"></i>
        </a>
      </div>
    </div>
  </div>
</section>

<script define:vars={{ certifications }}>
  (function () {
    function init() {
      const container = document.getElementById('certification');
      if (!container) return;
      const truncate = (s, max = 150) => (s.length > max ? s.slice(0, max) + '...' : s);
      const cap = (s) => s.charAt(0).toUpperCase() + s.toLowerCase().slice(1);
      const itemsToShow = () => (window.innerWidth < 768 ? 1 : 3);

      function renderCards() {
        const n = itemsToShow();
        const limited = certifications.slice(0, n);
        container.innerHTML = limited
          .map(
            (item, i) => `
        <div class="col-lg-4 col-md-6 col-12 pb-5" data-aos="fade-up" data-anim-item="card-item">
          <div class="class-thumb" data-toggle="modal" data-target="#certificationModal" data-title="${item.name.replace(/"/g, '&quot;')}" data-description="${item.description.replace(/"/g, '&quot;')}" data-img="${item.img}" data-repository="${item.repository || ''}" role="button" tabindex="0">
            <img src="${item.img}" class="img-fluid" alt="${item.name.replace(/"/g, '&quot;')}" />
          <div class="class-info">
            <h3 class="card-name mb-1">${item.name}</h3>
            <p class="card-description mt-3 card-description-text">${truncate(item.description)}</p>
            <div class="tag-container">
              <ul class="list-inline mt-3 tag-container">
                ${item.skill.slice(0, 3).map((s) => `<li class="list-inline-item"><span class="tag"><strong>${cap(s)}</strong></span></li>`).join('')}
              </ul>
            </div>
          </div>
        </div>
      </div>`
          )
          .join('');
        container.querySelectorAll('.class-thumb[data-target="#certificationModal"]').forEach((el) => {
          el.addEventListener('click', function () {
            const t = this;
            const titleEl = document.getElementById('certificationModalLabel');
            const descEl = document.getElementById('certificationModalDescription');
            const imgEl = document.getElementById('certificationModalImage');
            const linkEl = document.getElementById('certificationModalLink');
            if (titleEl) titleEl.textContent = t.dataset.title || '';
            if (descEl) descEl.textContent = truncate(t.dataset.description || '');
            if (imgEl) { imgEl.src = t.dataset.img || ''; imgEl.alt = t.dataset.title || ''; }
            if (linkEl) {
              linkEl.href = t.dataset.repository || '#';
              linkEl.style.display = t.dataset.repository ? 'block' : 'none';
            }
          });
        });
      }

      function fillTable() {
        const tbody = document.querySelector('#certificationList .modal-body tbody');
        if (!tbody) return;
        tbody.innerHTML = certifications
          .map(
            (c) => `
        <tr>
          <td>${c.name}</td>
          <td>${c.date ?? '-'}</td>
          <td>${c.repository ? `<button type="button" class="btn custom-btn-table w-100 mb-2 pl-2 pr-2" onclick="window.open('${c.repository}', '_blank')">Ver</button>` : '-'}</td>
        </tr>`
          )
          .join('');
      }

      fillTable();
      renderCards();

      if (window.applyGlobalAnimations) window.applyGlobalAnimations();

      window.addEventListener('resize', function () {
        renderCards();
        if (window.applyGlobalAnimations) window.applyGlobalAnimations();
      });
    }

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
    else init();
  })();
</script>
